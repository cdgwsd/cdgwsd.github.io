---
title: 反向代理
tags:
  - nginx
  - 反向代理
categories:
  - Nginx
date: 2024-04-01 16:04:13
---
# 反向代理

**反向代理**，就是将前端发送的动态请求由代理服务器转发到后端服务器

<img src="https://cdgwsd.oss-cn-guangzhou.aliyuncs.com/img/202404011625870.png" alt="image-20221107152112092" style="zoom:67%;" />

**nginx 反向代理的好处：**

- 提高访问速度

  因为 nginx 本身可以进行缓存，如果访问的同一接口，并且做了数据缓存，nginx 就直接可把数据返回，不需要真正地访问服务端，从而提高访问速度

- 负载均衡

  所谓负载均衡，就是把大量的请求按照我们指定的方式均衡的分配给集群中的每台服务器

- 保证后端服务安全

  因为一般后台服务地址不会暴露，所以使用浏览器不能直接访问，可以把 nginx 作为请求访问的入口，请求到达 nginx 后转发到具体的服务中，从而保证后端服务的安全

<img src="https://cdgwsd.oss-cn-guangzhou.aliyuncs.com/img/202404011630048.png" alt="image-20221107153808368" style="zoom:67%;" />

## 反向代理配置

```nginx
server{
    listen 80;
    server_name localhost;
    
    location /api/{
        # 反向代理
        proxy_pass http://localhost:8080/admin/;
    }
}
```

上面配置将监听 80 端口，并将所有请求 `localhost`，并且以`/api/`开头的请求通过反向代理转发到`http://localhost:8080/admin/`

各配置项含义如下：

- `listen 80;`：定义了该服务器块监听的端口是 80，也就是说该服务器块将处理所有来自该端口的请求
- `server_name localhost;`：指定了该服务器块所匹配的域名是 localhost。如果一个请求 Host 头中的值和server_name 匹配，nginx 会将其发送到这个服务器块
- `location /api/ { ... }`：这个部分定义了一个位置块，用来匹配所有以 `/api/` 开头的URI。这意味着所有以 `/api/` 开头的请求都将被发送到这里处理
- `proxy_pass http://localhost:8080/admin/;`：这里是配置反向代理。它将匹配到的请求转发到指定的后端服务器。具体来说，它将所有匹配到的请求发送到 `http://localhost:8080/admin/`。这意味着nginx 会将来自 `/api/` 开头的请求发送到 `http://localhost:8080/admin/`，并且保持URI不变

## 负载均衡

当如果服务以集群的方式进行部署时，那 nginx 在转发请求到服务器时就需要做相应的负载均衡。其实，负载均衡从本质上来说也是基于反向代理来实现的，最终都是转发请求

### 负载均衡配置

```nginx
upstream webservers{
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
server{
    listen 80;
    server_name localhost;
    
    location /api/{
        # 负载均衡
        proxy_pass http://webservers/admin;
    }
}
```

**upstream：**如果代理服务器是一组服务器的话，我们可以使用 `upstream` 指令配置后端服务器组。<font color=red>upstream 后面的名称可自定义，但要上下保持一致</font>

上面配置的作用是：进行反向代理时，根据 `webservers` 名称找到一组服务器，根据设置的负载均衡策略（默认是轮询）转发到具体的服务器

### 负载均衡策略

| **名称**   | **说明**                                               |
| ---------- | ------------------------------------------------------ |
| 轮询       | 默认方式                                               |
| weight     | 权重方式，默认为1，权重越高，被分配的客户端请求就越多  |
| ip_hash    | 依据ip分配方式，这样每个访客可以固定访问一个后端服务   |
| least_conn | 依据最少连接方式，把请求优先分配给连接数少的后端服务   |
| url_hash   | 依据url分配方式，这样相同的url会被分配到同一个后端服务 |
| fair       | 依据响应时间方式，响应时间短的服务将会被优先分配       |

**轮询：**

```nginx
upstream webservers{
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

**weight:**

```nginx
upstream webservers{
    server 192.168.100.128:8080 weight=90;
    server 192.168.100.129:8080 weight=10;
}
```

**ip_hash:**

```nginx
upstream webservers{
    ip_hash;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

**least_conn:**

```nginx
upstream webservers{
    least_conn;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

**url_hash:**

```nginx
upstream webservers{
    hash &request_uri;
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
}
```

**fair:**

```nginx
upstream webservers{
    server 192.168.100.128:8080;
    server 192.168.100.129:8080;
    fair;
}
```
